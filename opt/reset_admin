<?php
session_start();
require_once 'conexion.php';

$errors = [];
$ok     = '';
$uid    = isset($_GET['uid']) ? (int)$_GET['uid'] : (int)($_POST['uid'] ?? 0);
$token  = $_GET['token'] ?? ($_POST['token'] ?? '');

// CSRF
if (empty($_SESSION['csrf_token'])) {
  $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

function validar_password(string $p1, string $p2, array &$errors): ?string {
  if ($p1 === '' || $p2 === '') { $errors[] = "Todos los campos son obligatorios."; return null; }
  if ($p1 !== $p2) { $errors[] = "Las contraseñas no coinciden."; return null; }
  if (strlen($p1) < 8) { $errors[] = "La contraseña debe tener al menos 8 caracteres."; return null; }
  return password_hash($p1, PASSWORD_DEFAULT);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    $errors[] = "Error de validación CSRF.";
  } else {
    $pass1 = $_POST['pass1'] ?? '';
    $pass2 = $_POST['pass2'] ?? '';
    $hash  = validar_password($pass1, $pass2, $errors);

    if (empty($errors)) {
      try {
        // validar token vigente
        $q = $conn->prepare("
          SELECT id, expira_en
          FROM password_resets
          WHERE tipo='admin' AND user_id=:uid AND token=:tok
          LIMIT 1
        ");
        $q->execute([':uid' => $uid, ':tok' => $token]);
        $row = $q->fetch(PDO::FETCH_ASSOC);

        if (!$row) {
          $errors[] = "El enlace no es válido o ya fue utilizado.";
        } else {
          if (new DateTime() > new DateTime($row['expira_en'])) {
            $errors[] = "El enlace ha expirado. Solicita uno nuevo.";
          } else {
            // actualizar contraseña en admincuentas
            $u = $conn->prepare("UPDATE admincuentas SET contraseña=:p WHERE adminId=:id");
            $u->execute([':p' => $hash, ':id' => $uid]);

            // invalidar token
            $d = $conn->prepare("DELETE FROM password_resets WHERE id=:id");
            $d->execute([':id' => $row['id']]);

            $ok = "Tu contraseña fue actualizada correctamente.";
          }
        }
      } catch (Throwable $e) {
        $errors[] = "No se pudo actualizar la contraseña: " . $e->getMessage();
      }
    }
  }
  // rotar CSRF
  $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
} else {
  if ($uid <= 0 || !$token) $errors[] = "Enlace inválido.";
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restablecer contraseña · Admin</title>
  <link rel="stylesheet" href="../css/login-choice.css" />
</head>
<body class="registro-page">

<div class="registro-container">
  <div class="registro-header">
    <h2>Restablecer contraseña</h2>
    <p>Define una nueva contraseña para tu cuenta de administrador.</p>
  </div>

  <?php if ($ok): ?>
    <div class="alert success"><?php echo htmlspecialchars($ok); ?></div>
    <div class="form-actions" style="text-align:center;margin-top:14px">
      <button class="btn-submit" onclick="location.href='login_admin.php'">Ir a iniciar sesión</button>
    </div>
  <?php else: ?>

    <?php if ($errors): ?>
      <div class="alert error">
        <ul><?php foreach ($errors as $er) echo '<li>'.htmlspecialchars($er).'</li>'; ?></ul>
      </div>
    <?php endif; ?>

    <form method="POST" action="">
      <input type="hidden" name="csrf_token" value="<?php echo htmlspecialchars($_SESSION['csrf_token']); ?>" />
      <input type="hidden" name="uid"   value="<?php echo (int)$uid; ?>" />
      <input type="hidden" name="token" value="<?php echo htmlspecialchars($token); ?>" />

      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
          <label for="pass1">Nueva contraseña *</label>
          <input type="password" id="pass1" name="pass1" placeholder="Mínimo 8 caracteres" required />
        </div>
        <div class="form-group">
          <label for="pass2">Confirmar contraseña *</label>
          <input type="password" id="pass2" name="pass2" placeholder="Repite tu contraseña" required />
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-submit">Actualizar contraseña</button>
        <button type="button" class="btn-secondary" onclick="location.href='login_admin.php'">Cancelar</button>
      </div>
    </form>
  <?php endif; ?>
</div>
</body>
</html>
